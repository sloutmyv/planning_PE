{% extends 'core/base.html' %}

{% block title %}Roulements Hebdomadaires - Planning PE{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}

{% block content %}

<script>
// Simple period toggle function
function togglePeriod(element) {
    const periodId = element.getAttribute('data-period-id');
    if (!periodId) return;
    
    const weeksSection = document.getElementById('weeks-section-' + periodId);
    if (weeksSection) {
        if (weeksSection.style.display === 'none') {
            weeksSection.style.display = 'block';
            
            // Find the Alpine.js component for this period
            const alpineComponent = element.closest('[x-data]');
            if (alpineComponent && typeof Alpine !== 'undefined') {
                const alpineData = Alpine.$data(alpineComponent);
                if (alpineData) {
                    // Set loading state
                    alpineData.weeksLoaded = false;
                    
                    // Load weeks data
                    fetch(`/api/shift-schedule-periods/${periodId}/weeks/`)
                        .then(response => response.json())
                        .then(data => {
                            // Update Alpine.js state with the loaded data
                            alpineData.weeks = data.weeks || [];
                            alpineData.weeksLoaded = true;
                            
                            // Also load rotation plans for the dropdowns
                            const scheduleComponent = alpineComponent.closest('[x-data]');
                            if (scheduleComponent) {
                                const scheduleData = Alpine.$data(scheduleComponent);
                                if (scheduleData && typeof scheduleData.loadRotationPlans === 'function') {
                                    scheduleData.loadRotationPlans();
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error loading weeks:', error);
                            alpineData.weeksLoaded = true; // Set to true to hide loading state
                            alpineData.weeks = [];
                        });
                }
            }
        } else {
            weeksSection.style.display = 'none';
        }
    }
}

// Function to open week creation modal
function openWeekModal(element) {
    const periodId = element.getAttribute('data-period-id');
    if (!periodId) return;
    
    // Clear modal content
    const contentDiv = document.getElementById('week-create-form-content');
    if (!contentDiv) return;
    
    contentDiv.innerHTML = `
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    `;
    
    // Show modal
    const modal = document.getElementById('week-modal');
    if (!modal) return;
    modal.style.display = 'block';
    
    // Load create form
    if (typeof htmx !== 'undefined') {
        htmx.ajax('GET', `/shift-schedule-periods/${periodId}/weeks/create/`, '#week-create-form-content');
    } else {
        contentDiv.innerHTML = '<p style="color: red;">HTMX is not loaded. Please refresh the page.</p>';
    }
}

// Function to open daily plan modal
window.openDailyPlanModal = function(weekId, weekday, dayName) {
    console.log('Opening daily plan modal for:', { weekId, weekday, dayName });
    
    // Clear modal content and show loading
    const contentDiv = document.getElementById('daily-plan-form-content');
    if (!contentDiv) {
        console.error('daily-plan-form-content not found');
        return;
    }
    
    contentDiv.innerHTML = `
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    `;
    
    // Update modal title
    const modalTitle = document.querySelector('#daily-plan-modal h2');
    if (modalTitle) {
        modalTitle.textContent = `Assigner un rythme - ${dayName}`;
    }
    
    // Show modal
    const modal = document.getElementById('daily-plan-modal');
    if (modal) {
        modal.style.display = 'block';
    }
    
    // Load daily plan form
    if (typeof htmx !== 'undefined') {
        console.log('Loading form via HTMX:', `/shift-schedule-weeks/${weekId}/daily-plans/create/${weekday}/`);
        htmx.ajax('GET', `/shift-schedule-weeks/${weekId}/daily-plans/create/${weekday}/`, '#daily-plan-form-content');
    } else {
        console.error('HTMX is not loaded');
        contentDiv.innerHTML = '<p style="color: red;">HTMX is not loaded. Please refresh the page.</p>';
    }
}

// Function to remove a daily plan
window.removeDailyPlan = function(dailyPlanId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce rythme quotidien ?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/shift-schedule-daily-plans/${dailyPlanId}/delete/`, {
        method: 'POST',
        body: formData,
        headers: {
            'Accept': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh the weeks data for the specific period to show the updated table
            fetch(`/api/shift-schedule-periods/${data.period_id}/weeks/`)
                .then(response => response.json())
                .then(weeksData => {
                    // Find the Alpine.js component for this specific period and update its weeks data
                    const periodElements = document.querySelectorAll('[x-data]');
                    for (let element of periodElements) {
                        if (element._x_dataStack && element._x_dataStack[0].periodId === data.period_id) {
                            const alpineData = element._x_dataStack[0];
                            alpineData.weeks = weeksData.weeks;
                            alpineData.weeksLoaded = true;
                            break;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error refreshing weeks:', error);
                    // Fallback: reload the page if API call fails
                    location.reload();
                });
        } else {
            alert('Erreur lors de la suppression du rythme');
        }
    })
    .catch(error => {
        console.error('Error removing daily plan:', error);
        alert('Erreur lors de la suppression du rythme');
    });
}

</script>

<script>
function clearModalAndCreateSchedule() {
    console.log('clearModalAndCreateSchedule called');
    
    // Check if HTMX is loaded
    if (typeof htmx === 'undefined') {
        console.error('HTMX is not loaded!');
        alert('HTMX is not loaded. Please refresh the page.');
        return;
    }
    
    // Clear modal content
    const contentDiv = document.getElementById('schedule-create-form-content');
    if (!contentDiv) {
        console.error('schedule-create-form-content element not found!');
        return;
    }
    
    contentDiv.innerHTML = `
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    `;
    
    // Show modal
    const modal = document.getElementById('schedule-modal');
    if (!modal) {
        console.error('schedule-modal element not found!');
        return;
    }
    modal.style.display = 'block';
    
    // Load create form
    console.log('Loading create form...');
    try {
        htmx.ajax('GET', '{% url "shift_schedule_create" %}', '#schedule-create-form-content');
    } catch (error) {
        console.error('HTMX ajax failed:', error);
        contentDiv.innerHTML = '<p style="color: red;">Error loading form. Please refresh and try again.</p>';
    }
}

function clearModalAndEditSchedule(editUrl) {
    console.log('clearModalAndEditSchedule called with URL:', editUrl);
    
    // Check if HTMX is loaded
    if (typeof htmx === 'undefined') {
        console.error('HTMX is not loaded!');
        alert('HTMX is not loaded. Please refresh the page.');
        return;
    }
    
    // Clear modal content
    const contentDiv = document.getElementById('schedule-create-form-content');
    if (!contentDiv) {
        console.error('schedule-create-form-content element not found!');
        return;
    }
    
    contentDiv.innerHTML = `
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    `;
    
    // Show modal
    const modal = document.getElementById('schedule-modal');
    if (!modal) {
        console.error('schedule-modal element not found!');
        return;
    }
    modal.style.display = 'block';
    
    // Load edit form
    console.log('Loading edit form...');
    try {
        htmx.ajax('GET', editUrl, '#schedule-create-form-content');
    } catch (error) {
        console.error('HTMX ajax failed:', error);
        contentDiv.innerHTML = '<p style="color: red;">Error loading form. Please refresh and try again.</p>';
    }
}

function clearModalAndCreatePeriod(scheduleId) {
    console.log('clearModalAndCreatePeriod called with schedule ID:', scheduleId);
    
    // Check if HTMX is loaded
    if (typeof htmx === 'undefined') {
        console.error('HTMX is not loaded!');
        alert('HTMX is not loaded. Please refresh the page.');
        return;
    }
    
    // Clear modal content
    const contentDiv = document.getElementById('period-create-form-content');
    if (!contentDiv) {
        console.error('period-create-form-content element not found!');
        return;
    }
    
    contentDiv.innerHTML = `
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    `;
    
    // Show modal
    const modal = document.getElementById('period-modal');
    if (!modal) {
        console.error('period-modal element not found!');
        return;
    }
    modal.style.display = 'block';
    
    // Load create form
    console.log('Loading period create form...');
    try {
        htmx.ajax('GET', `/shift-schedules/${scheduleId}/periods/create/`, '#period-create-form-content');
    } catch (error) {
        console.error('HTMX ajax failed:', error);
        contentDiv.innerHTML = '<p style="color: red;">Error loading form. Please refresh and try again.</p>';
    }
}

function clearModalAndEditPeriod(periodId) {
    console.log('clearModalAndEditPeriod called with period ID:', periodId);
    
    // Check if HTMX is loaded
    if (typeof htmx === 'undefined') {
        console.error('HTMX is not loaded!');
        alert('HTMX is not loaded. Please refresh the page.');
        return;
    }
    
    // Clear modal content
    const contentDiv = document.getElementById('period-create-form-content');
    if (!contentDiv) {
        console.error('period-create-form-content element not found!');
        return;
    }
    
    contentDiv.innerHTML = `
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    `;
    
    // Show modal
    const modal = document.getElementById('period-modal');
    if (!modal) {
        console.error('period-modal element not found!');
        return;
    }
    modal.style.display = 'block';
    
    // Load edit form
    console.log('Loading period edit form...');
    try {
        htmx.ajax('GET', `/shift-schedule-periods/${periodId}/edit/`, '#period-create-form-content');
    } catch (error) {
        console.error('HTMX ajax failed:', error);
        contentDiv.innerHTML = '<p style="color: red;">Error loading form. Please refresh and try again.</p>';
    }
}

function clearModalAndDuplicatePeriod(periodId) {
    console.log('clearModalAndDuplicatePeriod called with period ID:', periodId);
    
    // Check if HTMX is loaded
    if (typeof htmx === 'undefined') {
        console.error('HTMX is not loaded!');
        alert('HTMX is not loaded. Please refresh the page.');
        return;
    }
    
    // Clear modal content
    const contentDiv = document.getElementById('period-create-form-content');
    if (!contentDiv) {
        console.error('period-create-form-content element not found!');
        return;
    }
    
    contentDiv.innerHTML = `
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    `;
    
    // Show modal
    const modal = document.getElementById('period-modal');
    if (!modal) {
        console.error('period-modal element not found!');
        return;
    }
    modal.style.display = 'block';
    
    // Load duplicate form
    console.log('Loading period duplicate form...');
    try {
        htmx.ajax('GET', `/shift-schedule-periods/${periodId}/duplicate/`, '#period-create-form-content');
    } catch (error) {
        console.error('HTMX ajax failed:', error);
        contentDiv.innerHTML = '<p style="color: red;">Error loading form. Please refresh and try again.</p>';
    }
}

function clearModalAndDuplicateWeek(weekId) {
    console.log('clearModalAndDuplicateWeek called with week ID:', weekId);
    
    // Check if HTMX is loaded
    if (typeof htmx === 'undefined') {
        console.error('HTMX is not loaded!');
        alert('HTMX is not loaded. Please refresh the page.');
        return;
    }
    
    // Clear modal content
    const contentDiv = document.getElementById('week-create-form-content');
    if (!contentDiv) {
        console.error('week-create-form-content element not found!');
        return;
    }
    
    contentDiv.innerHTML = `
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    `;
    
    // Show modal
    const modal = document.getElementById('week-modal');
    if (!modal) {
        console.error('week-modal element not found!');
        return;
    }
    modal.style.display = 'block';
    
    // Load duplicate form
    console.log('Loading week duplicate form...');
    try {
        htmx.ajax('GET', `/shift-schedule-weeks/${weekId}/duplicate/`, '#week-create-form-content');
    } catch (error) {
        console.error('HTMX ajax failed:', error);
        contentDiv.innerHTML = '<p style="color: red;">Error loading form. Please refresh and try again.</p>';
    }
}

function createWeekInstantly(periodId) {
    console.log('createWeekInstantly called with period ID:', periodId);
    
    if (typeof htmx === 'undefined') {
        console.error('HTMX is not loaded!');
        alert('HTMX is not loaded. Please refresh the page.');
        return;
    }
    
    // Make the request and handle success
    fetch(`/shift-schedule-periods/${periodId}/weeks/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'HX-Request': 'true'
        },
        body: ''
    })
    .then(response => {
        if (response.ok) {
            console.log('Week created successfully');
            
            // Get the period ID from the server response (should match the one we sent)
            return response.text().then(returnedPeriodId => {
                console.log('Period ID from server:', returnedPeriodId);
                
                // Refresh the UI directly using existing functions
                if (returnedPeriodId && typeof refreshPeriodWeeks === 'function') {
                    refreshPeriodWeeks(parseInt(returnedPeriodId));
                }
                
                // Also refresh the main schedule to update counts
                if (returnedPeriodId && typeof refreshSchedulePeriods === 'function') {
                    // Find the schedule ID from the current period
                    const scheduleElements = document.querySelectorAll('[x-data]');
                    for (let element of scheduleElements) {
                        if (element._x_dataStack && element._x_dataStack.length > 0) {
                            for (let dataLevel of element._x_dataStack) {
                                if (dataLevel.periodId === parseInt(returnedPeriodId)) {
                                    if (dataLevel.scheduleId || dataLevel.schedule_id) {
                                        refreshSchedulePeriods(dataLevel.scheduleId || dataLevel.schedule_id);
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            console.error('Failed to create week');
            alert('Erreur lors de la création de la semaine');
        }
    })
    .catch(error => {
        console.error('Error creating week:', error);
        alert('Error creating week. Please try again.');
    });
}

function duplicateWeekInstantly(weekId) {
    console.log('duplicateWeekInstantly called with week ID:', weekId);
    
    if (typeof htmx === 'undefined') {
        console.error('HTMX is not loaded!');
        alert('HTMX is not loaded. Please refresh the page.');
        return;
    }
    
    // Make the request and handle success
    fetch(`/shift-schedule-weeks/${weekId}/duplicate/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'HX-Request': 'true'
        },
        body: ''
    })
    .then(response => {
        if (response.ok) {
            console.log('Week duplicated successfully');
            
            // Get the period ID from the server response
            return response.text().then(periodId => {
                console.log('Period ID from server:', periodId);
                
                // Refresh the UI directly using existing functions
                if (periodId && typeof refreshPeriodWeeks === 'function') {
                    refreshPeriodWeeks(parseInt(periodId));
                }
                
                // Also refresh the main schedule to update counts
                if (periodId && typeof refreshSchedulePeriods === 'function') {
                    // Find the schedule ID from the current period
                    const scheduleElements = document.querySelectorAll('[x-data]');
                    for (let element of scheduleElements) {
                        if (element._x_dataStack && element._x_dataStack.length > 0) {
                            for (let dataLevel of element._x_dataStack) {
                                if (dataLevel.periodId === parseInt(periodId)) {
                                    if (dataLevel.scheduleId || dataLevel.schedule_id) {
                                        refreshSchedulePeriods(dataLevel.scheduleId || dataLevel.schedule_id);
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            console.error('Failed to duplicate week');
            alert('Erreur lors de la duplication de la semaine');
        }
    })
    .catch(error => {
        console.error('Error duplicating week:', error);
        alert('Error duplicating week. Please try again.');
    });
}

function clearModalAndAddWeek(periodId) {
    console.log('clearModalAndAddWeek called with period ID:', periodId);
    
    // Check if HTMX is loaded
    if (typeof htmx === 'undefined') {
        console.error('HTMX is not loaded!');
        alert('HTMX is not loaded. Please refresh the page.');
        return;
    }
    
    // Clear modal content
    const contentDiv = document.getElementById('week-create-form-content');
    if (!contentDiv) {
        console.error('week-create-form-content element not found!');
        return;
    }
    
    contentDiv.innerHTML = `
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    `;
    
    // Show modal
    const modal = document.getElementById('week-modal');
    if (!modal) {
        console.error('week-modal element not found!');
        return;
    }
    modal.style.display = 'block';
    
    // Load create form
    console.log('Loading week create form...');
    try {
        htmx.ajax('GET', `/shift-schedule-periods/${periodId}/weeks/create/`, '#week-create-form-content');
    } catch (error) {
        console.error('HTMX ajax failed:', error);
        contentDiv.innerHTML = '<p style="color: red;">Error loading form. Please refresh and try again.</p>';
    }
}
</script>
<div class="space-y-6">
    {% csrf_token %}
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-900">Roulements hebdomadaires</h1>
                <button onclick="clearModalAndCreateSchedule()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Nouveau Roulement
                </button>
            </div>

        <!-- Search Section -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex flex-col sm:flex-row gap-4 items-end">
                <div class="flex-1">
                    <input type="text" 
                           name="search" 
                           value="{{ search_query }}"
                           placeholder="Rechercher par nom..." 
                           class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                           hx-get="{% url 'shift_schedule_list' %}"
                           hx-trigger="keyup changed delay:300ms"
                           hx-target="#shift-schedule-list-content"
                           hx-include="[name='search']">
                </div>
            </div>
        </div>

        <!-- Schedules List -->
        <div id="shift-schedule-list-content">
            <!-- Shift Schedule Accordion -->
            <div class="space-y-4">
                {% if schedules %}
                    {% for schedule in schedules %}
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200" x-data="{ 
                        expanded: false, 
                        scheduleId: {{ schedule.pk }},
                        periodsLoaded: false,
                        periods: [],
                        rotationPlans: [],
                        rotationPlansLoaded: false,
                        loadPeriods() {
                            fetch(`/api/shift-schedules/${this.scheduleId}/periods/`)
                                .then(response => response.json())
                                .then(data => {
                                    this.periods = data.periods;
                                    this.periodsLoaded = true;
                                })
                                .catch(error => {
                                    console.error('Error loading periods:', error);
                                    this.periodsLoaded = true;
                                });
                        },
                        loadRotationPlans() {
                            if (!this.rotationPlansLoaded) {
                                fetch('/api/daily-rotation-plans/')
                                    .then(response => response.json())
                                    .then(data => {
                                        this.rotationPlans = data.plans;
                                        this.rotationPlansLoaded = true;
                                    })
                                    .catch(error => {
                                        console.error('Error loading rotation plans:', error);
                                        this.rotationPlansLoaded = true;
                                    });
                            }
                        },
                        assignPlan(weekId, weekday, planId) {
                            if (!planId) return;
                            
                            const formData = new FormData();
                            formData.append('plan_id', planId);
                            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                            
                            fetch(`/api/shift-schedule-weeks/${weekId}/assign-daily-plan/${weekday}/`, {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Refresh the periods to show updated data
                                    this.loadPeriods();
                                } else {
                                    alert('Erreur: ' + (data.error || 'Une erreur est survenue'));
                                }
                            })
                            .catch(error => {
                                console.error('Error assigning plan:', error);
                                alert('Erreur lors de l\'assignation du plan');
                            });
                        }
                    }">
                        <!-- Schedule Header (clickable to expand) -->
                        <div class="px-6 py-4 cursor-pointer hover:bg-gray-50 transition-colors"
                             @click="expanded = !expanded; if (expanded && !periodsLoaded) { loadPeriods() }">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <!-- Expand/Collapse Icon -->
                                        <svg class="w-5 h-5 text-gray-400 transition-transform duration-200 mr-4 flex-shrink-0"
                                             :class="{ 'rotate-90': expanded }"
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                        
                                        <!-- Schedule Info Grid -->
                                        <div class="flex-1 grid grid-cols-1 lg:grid-cols-4 gap-4 items-center">
                                            <!-- Schedule Name Column -->
                                            <div class="lg:col-span-2">
                                                <h3 class="text-lg font-medium text-gray-900 mb-1">{{ schedule.name }}</h3>
                                            </div>
                                            
                                            <!-- Schedule Type Column -->
                                            <div class="flex items-center">
                                                <span class="text-sm text-gray-700">{{ schedule.get_type_display }}</span>
                                            </div>
                                            
                                            <!-- Statistics Column -->
                                            <div class="flex flex-col items-start space-y-2">
                                                <!-- Period Count -->
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                                    <span x-text="periodsLoaded ? periods.length : {{ schedule.periods.count }}"></span>&nbsp;période<span x-text="(periodsLoaded ? periods.length : {{ schedule.periods.count }}) > 1 ? 's' : ''"></span>
                                                </span>
                                                
                                                <!-- Created Date -->
                                                <span class="text-xs text-gray-500">
                                                    Créé le {{ schedule.created_at|date:"d/m/Y" }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="flex items-center space-x-1" @click.stop>
                                    <!-- Edit Schedule Button -->
                                    <button onclick="clearModalAndEditSchedule('{% url 'shift_schedule_edit' schedule.id %}')"
                                            title="Modifier le planning"
                                            class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-l-md bg-white text-sm font-medium text-gray-700 hover:bg-yellow-50 hover:text-yellow-600 hover:border-yellow-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    
                                    <!-- Delete Schedule Button -->
                                    <form method="post" action="{% url 'shift_schedule_delete' schedule.id %}" class="inline">
                                        {% csrf_token %}
                                        <button type="submit"
                                                onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce planning ? Toutes ses périodes seront également supprimées.')"
                                                title="Supprimer le planning"
                                                class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-r-md bg-white text-sm font-medium text-gray-700 hover:bg-red-50 hover:text-red-600 hover:border-red-300 -ml-px">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Periods Section (expandable) -->
                        <div x-show="expanded" 
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 transform scale-95"
                             x-transition:enter-end="opacity-100 transform scale-100"
                             x-transition:leave="transition ease-in duration-150"
                             x-transition:leave-start="opacity-100 transform scale-100"
                             x-transition:leave-end="opacity-0 transform scale-95"
                             class="border-t border-gray-200 bg-gray-50">
                            
                            <!-- Periods Header -->
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                <h4 class="text-md font-medium text-gray-900">
                                    Périodes pour ce planning (<span x-text="periods.length">{{ schedule.periods.count }}</span>)
                                </h4>
                                <button onclick="clearModalAndCreatePeriod({{ schedule.id }})"
                                        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Ajouter une période
                                </button>
                            </div>
                            
                            <!-- Periods Content -->
                            <div class="px-6 py-4" :id="'periods-content-' + scheduleId">
                                <div x-show="!periodsLoaded" class="text-center text-gray-500">
                                    <div class="animate-pulse">
                                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-4 mx-auto"></div>
                                        <div class="h-4 bg-gray-200 rounded w-1/2 mb-4 mx-auto"></div>
                                        <div class="h-4 bg-gray-200 rounded w-2/3 mx-auto"></div>
                                    </div>
                                </div>
                                
                                <div x-show="periodsLoaded && periods.length === 0" class="text-center text-gray-500 py-8">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <p class="mt-2 text-sm">Aucune période définie pour ce planning</p>
                                    <p class="text-xs text-gray-400">Ajoutez des périodes pour définir quand ce planning est actif</p>
                                </div>
                                
                                <div x-show="periodsLoaded && periods.length > 0" class="space-y-3">
                                    <template x-for="period in periods" :key="period.id">
                                        <div class="bg-white rounded-lg border border-gray-200" x-data="{ 
                                            periodExpanded: false, 
                                            periodId: period.id,
                                            weeksLoaded: false,
                                            weeks: [],
                                            loadWeeks() {
                                                fetch(`/api/shift-schedule-periods/${this.periodId}/weeks/`)
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        this.weeks = data.weeks;
                                                        this.weeksLoaded = true;
                                                    })
                                                    .catch(error => {
                                                        console.error('Error loading weeks:', error);
                                                        this.weeksLoaded = true;
                                                    });
                                            }
                                        }">
                                            <!-- Period Header (clickable to expand) -->
                                            <div class="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                                                 onclick="togglePeriod(this)" 
                                                 data-period-id="" 
                                                 x-bind:data-period-id="period.id">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center flex-1">
                                                        <!-- Expand/Collapse Arrow -->
                                                        <svg class="w-4 h-4 text-gray-400 transition-transform duration-200 mr-3 flex-shrink-0"
                                                             :class="{ 'rotate-90': periodExpanded }"
                                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                        </svg>
                                                        
                                                        <!-- Period Info Grid -->
                                                        <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                                                            <!-- Period Dates -->
                                                            <div>
                                                                <div class="text-sm font-medium text-gray-900" x-text="period.date_range"></div>
                                                                <div class="text-xs text-gray-500" x-text="period.duration_text"></div>
                                                            </div>
                                                            
                                                            <!-- Weeks Count -->
                                                            <div>
                                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800"
                                                                      x-text="period.weeks_count + ' semaine' + (period.weeks_count > 1 ? 's' : '')"></span>
                                                            </div>
                                                            
                                                            <!-- Status -->
                                                            <div>
                                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                                                      :class="period.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                                                      x-text="period.status_text"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Period Actions -->
                                                    <div class="flex items-center space-x-1 ml-4" @click.stop>
                                                        <button @click="clearModalAndEditPeriod(period.id)"
                                                                title="Modifier la période"
                                                                class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-l-md bg-white text-sm font-medium text-gray-700 hover:bg-yellow-50 hover:text-yellow-600 hover:border-yellow-300">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                            </svg>
                                                        </button>
                                                        
                                                        <button @click="clearModalAndDuplicatePeriod(period.id)"
                                                                title="Dupliquer la période"
                                                                class="inline-flex items-center px-3 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-green-50 hover:text-green-600 hover:border-green-300 -ml-px">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                            </svg>
                                                        </button>
                                                        
                                                        <button @click="deletePeriod(period.id, scheduleId)"
                                                                title="Supprimer la période"
                                                                class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-r-md bg-white text-sm font-medium text-gray-700 hover:bg-red-50 hover:text-red-600 hover:border-red-300 -ml-px">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Weeks Section (expandable) -->
                                            <div id="" 
                                                 x-bind:id="'weeks-section-' + period.id"
                                                 style="display: none;"
                                                 class="border-t border-gray-200 bg-gray-50">
                                                
                                                <!-- Weeks Header -->
                                                <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                                                    <h5 class="text-sm font-medium text-gray-900">
                                                        Semaines pour cette période (<span x-text="weeks.length">0</span>)
                                                    </h5>
                                                    <button @click="createWeekInstantly(period.id)"
                                                            class="inline-flex items-center px-3 py-1 bg-blue-600 text-white rounded-md text-xs font-medium hover:bg-blue-700">
                                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                        </svg>
                                                        Ajouter une semaine
                                                    </button>
                                                </div>
                                                
                                                <!-- Weeks Content -->
                                                <div class="px-4 py-3">
                                                    <div x-show="!weeksLoaded" class="text-center text-gray-500">
                                                        <div class="animate-pulse">
                                                            <div class="h-3 bg-gray-200 rounded w-3/4 mb-2 mx-auto"></div>
                                                            <div class="h-3 bg-gray-200 rounded w-1/2 mx-auto"></div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div x-show="weeksLoaded && weeks.length === 0" class="text-center text-gray-500 py-4">
                                                        <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                        </svg>
                                                        <p class="mt-1 text-xs">Aucune semaine définie pour cette période</p>
                                                        <p class="text-xs text-gray-400">Cliquez sur "Ajouter une semaine" pour commencer</p>
                                                    </div>
                                                    
                                                    <div x-show="weeksLoaded && weeks.length > 0" class="overflow-x-auto">
                                                        <!-- Weekly Schedule Table -->
                                                        <table class="min-w-full bg-white border border-gray-200 rounded-lg table-fixed">
                                                            <colgroup>
                                                                <col class="w-16">  <!-- Semaine column -->
                                                                <col class="w-1/8"> <!-- Lundi -->
                                                                <col class="w-1/8"> <!-- Mardi -->
                                                                <col class="w-1/8"> <!-- Mercredi -->
                                                                <col class="w-1/8"> <!-- Jeudi -->
                                                                <col class="w-1/8"> <!-- Vendredi -->
                                                                <col class="w-1/8"> <!-- Samedi -->
                                                                <col class="w-1/8"> <!-- Dimanche -->
                                                                <col class="w-20">  <!-- Actions column -->
                                                            </colgroup>
                                                            <thead class="bg-gray-50">
                                                                <tr>
                                                                    <th class="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                                        Semaine
                                                                    </th>
                                                                    <th class="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                                        Lundi
                                                                    </th>
                                                                    <th class="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                                        Mardi
                                                                    </th>
                                                                    <th class="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                                        Mercredi
                                                                    </th>
                                                                    <th class="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                                        Jeudi
                                                                    </th>
                                                                    <th class="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                                        Vendredi
                                                                    </th>
                                                                    <th class="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                                        Samedi
                                                                    </th>
                                                                    <th class="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                                        Dimanche
                                                                    </th>
                                                                    <th class="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                                        Actions
                                                                    </th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="divide-y divide-gray-200">
                                                                <template x-for="week in weeks" :key="week.id">
                                                                    <tr class="hover:bg-gray-50">
                                                                        <!-- Week Number -->
                                                                        <td class="px-2 py-1 text-center text-xs font-medium text-gray-900">
                                                                            <span x-text="'S' + week.week_number"></span>
                                                                        </td>
                                                                        
                                                                        <!-- Monday -->
                                                                        <td class="px-1 py-1">
                                                                            <div class="min-h-8 flex flex-col items-center justify-center space-y-1">
                                                                                <!-- Assigned rhythms for Monday (multiple possible) -->
                                                                                <template x-if="week.daily_plans && week.daily_plans[1] && week.daily_plans[1].length > 0">
                                                                                    <div class="flex flex-col items-center space-y-1 w-full">
                                                                                        <template x-for="plan in week.daily_plans[1]" :key="plan.id">
                                                                                            <div class="inline-flex items-center px-1 py-0.5 text-xs rounded-full w-full max-w-20 justify-center font-medium relative group"
                                                                                                 :style="`background-color: ${plan.schedule_type_color || '#6B7280'}; color: ${getContrastColor(plan.schedule_type_color || '#6B7280')}`">
                                                                                                <span x-text="plan.full_name" class="truncate text-xs"></span>
                                                                                                <button @click="removeDailyPlan(plan.id)" 
                                                                                                        class="ml-1 hover:opacity-70 flex-shrink-0 text-xs">×</button>
                                                                                                <!-- Custom tooltip -->
                                                                                                <div class="absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50"
                                                                                                     x-text="plan.description ? `${plan.designation} - ${plan.description}` : plan.designation">
                                                                                                </div>
                                                                                            </div>
                                                                                        </template>
                                                                                    </div>
                                                                                </template>
                                                                                <!-- Add rhythm button -->
                                                                                <button @click="openDailyPlanModal(week.id, 1, 'Lundi')"
                                                                                        class="inline-flex items-center px-1 py-0.5 text-xs text-gray-600 border border-dashed border-gray-300 rounded hover:border-blue-300 hover:text-blue-600 w-full max-w-20 justify-center">
                                                                                    <svg class="w-2 h-2 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                                                    </svg>
                                                                                    <span class="truncate text-xs">Ajouter</span>
                                                                                </button>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!-- Tuesday -->
                                                                        <td class="px-1 py-1">
                                                                            <div class="min-h-8 flex flex-col items-center justify-center space-y-1">
                                                                                <!-- Assigned rhythms for Tuesday (multiple possible) -->
                                                                                <template x-if="week.daily_plans && week.daily_plans[2] && week.daily_plans[2].length > 0">
                                                                                    <div class="flex flex-col items-center space-y-1 w-full">
                                                                                        <template x-for="plan in week.daily_plans[2]" :key="plan.id">
                                                                                            <div class="inline-flex items-center px-1 py-0.5 text-xs rounded-full w-full max-w-20 justify-center font-medium relative group"
                                                                                                 :style="`background-color: ${plan.schedule_type_color || '#6B7280'}; color: ${getContrastColor(plan.schedule_type_color || '#6B7280')}`">
                                                                                                <span x-text="plan.full_name" class="truncate text-xs"></span>
                                                                                                <button @click="removeDailyPlan(plan.id)" 
                                                                                                        class="ml-1 hover:opacity-70 flex-shrink-0 text-xs">×</button>
                                                                                                <!-- Custom tooltip -->
                                                                                                <div class="absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50"
                                                                                                     x-text="plan.description ? `${plan.designation} - ${plan.description}` : plan.designation">
                                                                                                </div>
                                                                                            </div>
                                                                                        </template>
                                                                                    </div>
                                                                                </template>
                                                                                <!-- Add rhythm button -->
                                                                                <button @click="openDailyPlanModal(week.id, 2, 'Mardi')"
                                                                                        class="inline-flex items-center px-1 py-0.5 text-xs text-gray-600 border border-dashed border-gray-300 rounded hover:border-blue-300 hover:text-blue-600 w-full max-w-20 justify-center">
                                                                                    <svg class="w-2 h-2 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                                                    </svg>
                                                                                    <span class="truncate text-xs">Ajouter</span>
                                                                                </button>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!-- Wednesday -->
                                                                        <td class="px-1 py-1">
                                                                            <div class="min-h-8 flex flex-col items-center justify-center space-y-1">
                                                                                <!-- Assigned rhythms for Wednesday (multiple possible) -->
                                                                                <template x-if="week.daily_plans && week.daily_plans[3] && week.daily_plans[3].length > 0">
                                                                                    <div class="flex flex-col items-center space-y-1 w-full">
                                                                                        <template x-for="plan in week.daily_plans[3]" :key="plan.id">
                                                                                            <div class="inline-flex items-center px-1 py-0.5 text-xs rounded-full w-full max-w-20 justify-center font-medium relative group"
                                                                                                 :style="`background-color: ${plan.schedule_type_color || '#6B7280'}; color: ${getContrastColor(plan.schedule_type_color || '#6B7280')}`">
                                                                                                <span x-text="plan.full_name" class="truncate text-xs"></span>
                                                                                                <button @click="removeDailyPlan(plan.id)" 
                                                                                                        class="ml-1 hover:opacity-70 flex-shrink-0 text-xs">×</button>
                                                                                                <!-- Custom tooltip -->
                                                                                                <div class="absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50"
                                                                                                     x-text="plan.description ? `${plan.designation} - ${plan.description}` : plan.designation">
                                                                                                </div>
                                                                                            </div>
                                                                                        </template>
                                                                                    </div>
                                                                                </template>
                                                                                <!-- Add rhythm button -->
                                                                                <button @click="openDailyPlanModal(week.id, 3, 'Mercredi')"
                                                                                        class="inline-flex items-center px-1 py-0.5 text-xs text-gray-600 border border-dashed border-gray-300 rounded hover:border-blue-300 hover:text-blue-600 w-full max-w-20 justify-center">
                                                                                    <svg class="w-2 h-2 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                                                    </svg>
                                                                                    <span class="truncate text-xs">Ajouter</span>
                                                                                </button>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!-- Thursday -->
                                                                        <td class="px-1 py-1">
                                                                            <div class="min-h-8 flex flex-col items-center justify-center space-y-1">
                                                                                <!-- Assigned rhythms for Thursday (multiple possible) -->
                                                                                <template x-if="week.daily_plans && week.daily_plans[4] && week.daily_plans[4].length > 0">
                                                                                    <div class="flex flex-col items-center space-y-1 w-full">
                                                                                        <template x-for="plan in week.daily_plans[4]" :key="plan.id">
                                                                                            <div class="inline-flex items-center px-1 py-0.5 text-xs rounded-full w-full max-w-20 justify-center font-medium relative group"
                                                                                                 :style="`background-color: ${plan.schedule_type_color || '#6B7280'}; color: ${getContrastColor(plan.schedule_type_color || '#6B7280')}`">
                                                                                                <span x-text="plan.full_name" class="truncate text-xs"></span>
                                                                                                <button @click="removeDailyPlan(plan.id)" 
                                                                                                        class="ml-1 hover:opacity-70 flex-shrink-0 text-xs">×</button>
                                                                                                <!-- Custom tooltip -->
                                                                                                <div class="absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50"
                                                                                                     x-text="plan.description ? `${plan.designation} - ${plan.description}` : plan.designation">
                                                                                                </div>
                                                                                            </div>
                                                                                        </template>
                                                                                    </div>
                                                                                </template>
                                                                                <!-- Add rhythm button -->
                                                                                <button @click="openDailyPlanModal(week.id, 4, 'Jeudi')"
                                                                                        class="inline-flex items-center px-1 py-0.5 text-xs text-gray-600 border border-dashed border-gray-300 rounded hover:border-blue-300 hover:text-blue-600 w-full max-w-20 justify-center">
                                                                                    <svg class="w-2 h-2 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                                                    </svg>
                                                                                    <span class="truncate text-xs">Ajouter</span>
                                                                                </button>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!-- Friday -->
                                                                        <td class="px-1 py-1">
                                                                            <div class="min-h-8 flex flex-col items-center justify-center space-y-1">
                                                                                <!-- Assigned rhythms for Friday (multiple possible) -->
                                                                                <template x-if="week.daily_plans && week.daily_plans[5] && week.daily_plans[5].length > 0">
                                                                                    <div class="flex flex-col items-center space-y-1 w-full">
                                                                                        <template x-for="plan in week.daily_plans[5]" :key="plan.id">
                                                                                            <div class="inline-flex items-center px-1 py-0.5 text-xs rounded-full w-full max-w-20 justify-center font-medium relative group"
                                                                                                 :style="`background-color: ${plan.schedule_type_color || '#6B7280'}; color: ${getContrastColor(plan.schedule_type_color || '#6B7280')}`">
                                                                                                <span x-text="plan.full_name" class="truncate text-xs"></span>
                                                                                                <button @click="removeDailyPlan(plan.id)" 
                                                                                                        class="ml-1 hover:opacity-70 flex-shrink-0 text-xs">×</button>
                                                                                                <!-- Custom tooltip -->
                                                                                                <div class="absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50"
                                                                                                     x-text="plan.description ? `${plan.designation} - ${plan.description}` : plan.designation">
                                                                                                </div>
                                                                                            </div>
                                                                                        </template>
                                                                                    </div>
                                                                                </template>
                                                                                <!-- Add rhythm button -->
                                                                                <button @click="openDailyPlanModal(week.id, 5, 'Vendredi')"
                                                                                        class="inline-flex items-center px-1 py-0.5 text-xs text-gray-600 border border-dashed border-gray-300 rounded hover:border-blue-300 hover:text-blue-600 w-full max-w-20 justify-center">
                                                                                    <svg class="w-2 h-2 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                                                    </svg>
                                                                                    <span class="truncate text-xs">Ajouter</span>
                                                                                </button>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!-- Saturday -->
                                                                        <td class="px-1 py-1">
                                                                            <div class="min-h-8 flex flex-col items-center justify-center space-y-1">
                                                                                <!-- Assigned rhythms for Saturday (multiple possible) -->
                                                                                <template x-if="week.daily_plans && week.daily_plans[6] && week.daily_plans[6].length > 0">
                                                                                    <div class="flex flex-col items-center space-y-1 w-full">
                                                                                        <template x-for="plan in week.daily_plans[6]" :key="plan.id">
                                                                                            <div class="inline-flex items-center px-1 py-0.5 text-xs rounded-full w-full max-w-20 justify-center font-medium relative group"
                                                                                                 :style="`background-color: ${plan.schedule_type_color || '#6B7280'}; color: ${getContrastColor(plan.schedule_type_color || '#6B7280')}`">
                                                                                                <span x-text="plan.full_name" class="truncate text-xs"></span>
                                                                                                <button @click="removeDailyPlan(plan.id)" 
                                                                                                        class="ml-1 hover:opacity-70 flex-shrink-0 text-xs">×</button>
                                                                                                <!-- Custom tooltip -->
                                                                                                <div class="absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50"
                                                                                                     x-text="plan.description ? `${plan.designation} - ${plan.description}` : plan.designation">
                                                                                                </div>
                                                                                            </div>
                                                                                        </template>
                                                                                    </div>
                                                                                </template>
                                                                                <!-- Add rhythm button -->
                                                                                <button @click="openDailyPlanModal(week.id, 6, 'Samedi')"
                                                                                        class="inline-flex items-center px-1 py-0.5 text-xs text-gray-600 border border-dashed border-gray-300 rounded hover:border-blue-300 hover:text-blue-600 w-full max-w-20 justify-center">
                                                                                    <svg class="w-2 h-2 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                                                    </svg>
                                                                                    <span class="truncate text-xs">Ajouter</span>
                                                                                </button>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!-- Sunday -->
                                                                        <td class="px-1 py-1">
                                                                            <div class="min-h-8 flex flex-col items-center justify-center space-y-1">
                                                                                <!-- Assigned rhythms for Sunday (multiple possible) -->
                                                                                <template x-if="week.daily_plans && week.daily_plans[7] && week.daily_plans[7].length > 0">
                                                                                    <div class="flex flex-col items-center space-y-1 w-full">
                                                                                        <template x-for="plan in week.daily_plans[7]" :key="plan.id">
                                                                                            <div class="inline-flex items-center px-1 py-0.5 text-xs rounded-full w-full max-w-20 justify-center font-medium relative group"
                                                                                                 :style="`background-color: ${plan.schedule_type_color || '#6B7280'}; color: ${getContrastColor(plan.schedule_type_color || '#6B7280')}`">
                                                                                                <span x-text="plan.full_name" class="truncate text-xs"></span>
                                                                                                <button @click="removeDailyPlan(plan.id)" 
                                                                                                        class="ml-1 hover:opacity-70 flex-shrink-0 text-xs">×</button>
                                                                                                <!-- Custom tooltip -->
                                                                                                <div class="absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50"
                                                                                                     x-text="plan.description ? `${plan.designation} - ${plan.description}` : plan.designation">
                                                                                                </div>
                                                                                            </div>
                                                                                        </template>
                                                                                    </div>
                                                                                </template>
                                                                                <!-- Add rhythm button -->
                                                                                <button @click="openDailyPlanModal(week.id, 7, 'Dimanche')"
                                                                                        class="inline-flex items-center px-1 py-0.5 text-xs text-gray-600 border border-dashed border-gray-300 rounded hover:border-blue-300 hover:text-blue-600 w-full max-w-20 justify-center">
                                                                                    <svg class="w-2 h-2 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                                                    </svg>
                                                                                    <span class="truncate text-xs">Ajouter</span>
                                                                                </button>
                                                                            </div>
                                                                        </td>
                                                                        
                                                                        <!-- Actions -->
                                                                        <td class="px-1 py-1">
                                                                            <div class="min-h-8 flex flex-col items-center justify-center space-y-1">
                                                                                <button @click="editWeek(week.id)"
                                                                                        title="Modifier la semaine"
                                                                                        class="inline-flex items-center px-2 py-1 border border-gray-300 rounded bg-white text-xs font-medium text-gray-700 hover:bg-yellow-50 hover:text-yellow-600 w-full max-w-20 justify-center">
                                                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                                    </svg>
                                                                                </button>
                                                                                
                                                                                <button @click="duplicateWeekInstantly(week.id)"
                                                                                        title="Dupliquer la semaine"
                                                                                        class="inline-flex items-center px-2 py-1 border border-gray-300 rounded bg-white text-xs font-medium text-gray-700 hover:bg-green-50 hover:text-green-600 w-full max-w-20 justify-center">
                                                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                                                    </svg>
                                                                                </button>
                                                                                
                                                                                <button @click="deleteWeek(week.id, period.id, period.schedule_id)"
                                                                                        title="Supprimer la semaine"
                                                                                        class="inline-flex items-center px-2 py-1 border border-gray-300 rounded bg-white text-xs font-medium text-gray-700 hover:bg-red-50 hover:text-red-600 w-full max-w-20 justify-center">
                                                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                                    </svg>
                                                                                </button>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                </template>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-500">Aucun planning de poste trouvé</p>
                    {% if search_query %}
                    <p class="text-xs text-gray-400">Essayez de modifier votre recherche</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div id="schedule-modal" style="display: none;" class="bg-white rounded-lg shadow-lg border border-gray-200 p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-900">Créer un nouveau planning de poste</h2>
        <button onclick="document.getElementById('schedule-modal').style.display = 'none'" 
                class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
    <div id="schedule-create-form-content">
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    </div>
</div>

<!-- Period Modal -->
<div id="period-modal" style="display: none;" class="bg-white rounded-lg shadow-lg border border-gray-200 p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-900">Créer une nouvelle période</h2>
        <button onclick="document.getElementById('period-modal').style.display = 'none'" 
                class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
    <div id="period-create-form-content">
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    </div>
</div>

<!-- Week Modal -->
<div id="week-modal" style="display: none;" class="bg-white rounded-lg shadow-lg border border-gray-200 p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-900">Ajouter une semaine</h2>
        <button onclick="document.getElementById('week-modal').style.display = 'none'" 
                class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
    <div id="week-create-form-content">
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    </div>
</div>

<!-- Daily Plan Assignment Modal -->
<div id="daily-plan-modal" style="display: none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-medium text-gray-900">Assigner un rythme</h2>
            <button onclick="document.getElementById('daily-plan-modal').style.display = 'none'" 
                    class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="daily-plan-form-content">
            <div class="text-center py-4">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4 mx-auto"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
                </div>
            </div>
        </div>
    </div>
</div>

</div>

<script>
// Global functions for accordion functionality
function deletePeriod(periodId, scheduleId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette période ?')) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/shift-schedule-periods/${periodId}/delete/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.ok) {
                // Reload periods for this specific schedule
                refreshSchedulePeriods(scheduleId);
            } else {
                alert('Erreur lors de la suppression de la période');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la suppression de la période');
        });
    }
}

function refreshSchedulePeriods(scheduleId) {
    // Find the Alpine.js component for this schedule and reload its periods
    const scheduleElements = document.querySelectorAll('[x-data]');
    for (let element of scheduleElements) {
        if (element._x_dataStack && element._x_dataStack[0].scheduleId === scheduleId) {
            const alpineData = element._x_dataStack[0];
            alpineData.periodsLoaded = false;
            alpineData.loadPeriods();
            break;
        }
    }
}

function editWeek(weekId) {
    console.log('editWeek called with week ID:', weekId);
    
    // Check if HTMX is loaded
    if (typeof htmx === 'undefined') {
        console.error('HTMX is not loaded!');
        alert('HTMX is not loaded. Please refresh the page.');
        return;
    }
    
    // Clear modal content
    const contentDiv = document.getElementById('week-create-form-content');
    if (!contentDiv) {
        console.error('week-create-form-content element not found!');
        return;
    }
    
    contentDiv.innerHTML = `
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
        </div>
    `;
    
    // Show modal
    const modal = document.getElementById('week-modal');
    if (!modal) {
        console.error('week-modal element not found!');
        return;
    }
    modal.style.display = 'block';
    
    // Load edit form
    console.log('Loading week edit form...');
    try {
        htmx.ajax('GET', `/shift-schedule-weeks/${weekId}/edit/`, '#week-create-form-content');
    } catch (error) {
        console.error('HTMX ajax failed:', error);
        contentDiv.innerHTML = '<p style="color: red;">Error loading form. Please refresh and try again.</p>';
    }
}

function deleteWeek(weekId, periodId, scheduleId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette semaine ?')) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/shift-schedule-weeks/${weekId}/delete/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.ok) {
                // Reload weeks for this specific period
                refreshPeriodWeeks(periodId);
                // Also refresh schedule periods to update weeks count
                refreshSchedulePeriods(scheduleId);
            } else {
                alert('Erreur lors de la suppression de la semaine');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la suppression de la semaine');
        });
    }
}

function refreshPeriodWeeks(periodId) {
    console.log('refreshPeriodWeeks called with periodId:', periodId);
    
    // Find the Alpine.js component for this period and reload its weeks
    const periodElements = document.querySelectorAll('[x-data]');
    let found = false;
    
    for (let element of periodElements) {
        if (element._x_dataStack && element._x_dataStack.length > 0) {
            // Check all data stack levels for periodId
            for (let dataLevel of element._x_dataStack) {
                if (dataLevel.periodId === periodId) {
                    console.log('Found period element, refreshing weeks...');
                    dataLevel.weeksLoaded = false;
                    dataLevel.weeks = [];
                    dataLevel.loadWeeks();
                    found = true;
                    break;
                }
            }
            if (found) break;
        }
    }
    
    if (!found) {
        console.warn('Could not find Alpine.js component for period ID:', periodId);
        // Fallback: reload all expanded periods
        const expandedPeriods = document.querySelectorAll('[x-data] div[x-show="periodExpanded"]');
        expandedPeriods.forEach(expandedDiv => {
            const parentElement = expandedDiv.closest('[x-data]');
            if (parentElement && parentElement._x_dataStack && parentElement._x_dataStack[0].periodExpanded) {
                console.log('Refreshing expanded period as fallback...');
                parentElement._x_dataStack[0].weeksLoaded = false;
                parentElement._x_dataStack[0].weeks = [];
                parentElement._x_dataStack[0].loadWeeks();
            }
        });
    }
}

// Function to determine if text should be white or black based on background color
function getContrastColor(hexColor) {
    // Remove # if present
    const color = hexColor.replace('#', '');
    
    // Convert to RGB
    const r = parseInt(color.substr(0, 2), 16);
    const g = parseInt(color.substr(2, 2), 16);
    const b = parseInt(color.substr(4, 2), 16);
    
    // Calculate relative luminance
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    
    // Return black for light colors, white for dark colors
    return luminance > 0.5 ? '#000000' : '#FFFFFF';
}

</script>
{% endblock %}